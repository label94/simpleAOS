# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane
default_platform(:android)

platform :android do
  desc "Runs all the tests"
  lane :test do
    gradle(task: "test")
  end

  desc "Submit a new Beta Build to Crashlytics Beta"
  lane :beta do
    gradle(task: "clean assembleRelease")
    crashlytics
  
    # sh "your_script.sh"
    # You can also use other beta testing services here
  end

  desc "Deploy a new version to the Google Play"
  lane :deploy do
    gradle(task: "clean assembleRelease")
    upload_to_play_store
  end

# # ğŸ”¹ ëª¨ë“  lane ì‹¤í–‰ ì „ì— ê³µí†µìœ¼ë¡œ í•œ ë²ˆë§Œ JDK ì„¤ì •
# before_all do
#     # JDK ë²„ì „
#     java_home = `/usr/libexec/java_home -v17`.strip
#
#     ENV["JAVA_HOME"] = java_home
#     ENV["PATH"] = "#{java_home}/bin:#{ENV["PATH"]}"
#
#     UI.message("ğŸ‘‰ fastlane ì‹¤í–‰ìš© JAVA_HOME: #{ENV["JAVA_HOME"]}")
# end

  ##############################################################
  # Firebase App Distribution ë°°í¬ lane
  # ì‹¤í–‰ ëª…ë ¹ì–´(ë””ë²„ê·¸) : bundle exec fastlane android firebase_debug
  # ì‹¤í–‰ ëª…ë ¹ì–´(ë¦´ë¦¬ì¦ˆ) : bundle exec fastlane android firebase_beta
  ##############################################################
  # ğŸ”¹ Debug ë¹Œë“œ + Firebase ë°°í¬
    desc "Build DEBUG apk and distribute to Firebase (internal/dev testers)"
    lane :firebase_debug do
      #1) debug ë¹Œë“œ
      gradle(task: "clean")
      gradle(task: "assembleDebug")

      # 2) debug APK ê²½ë¡œ ë™ì ìœ¼ë¡œ ì°¾ê¸°
      debug_apk_path = lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH]
      UI.user_error!("APK ê²½ë¡œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤") unless debug_apk_path

      UI.message("ì„ íƒ ëœ DEBUG APK ê²½ë¡œ : #{debug_apk_path}")

      UI.message("FIREBASE_APP_ID_ANDROID_DEBUG = #{ENV['FIREBASE_APP_ID_ANDROID_DEBUG']}")
      UI.message("FIREBASE_TESTERS_DEBUG = #{ENV['FIREBASE_TESTERS_DEBUG']}")

      # ì œëª© ì„¤ì •
      version_name = sh("grep versionName app/build.gradle | awk '{print $2}'").strip.gsub('"','')
      version_code = sh("grep versionCode app/build.gradle | awk '{print $2}'").strip
      release_title = "[ë‚´ë¶€ í…ŒìŠ¤íŠ¸] v#{version_name} (#{version_code})"

      # 3) Firebase App Distribution ì—…ë¡œë“œ
      firebase_app_distribution(
        app: ENV["FIREBASE_APP_ID_ANDROID_DEBUG"],        # ğŸ”¹ í•„ìš”í•˜ë©´ debugìš© ì•± ID ë”°ë¡œ
        android_artifact_type: "APK",
        android_artifact_path: debug_apk_path,
        service_credentials_file: "fastlane/account-firebase-app-distribution.json", # ì´ íŒŒì¼ì€ êµ¬ê¸€ í´ë¼ìš°ë“œ ì½˜ì†”ì—ì„œ ë‹¤ìš´ì„ ë°›ìœ¼ë©´ ë¨!!

        testers: ENV["FIREBASE_TESTERS_DEBUG"],          # debug ì „ìš© í…ŒìŠ¤í„°
        release_notes: "DEBUG ë¹Œë“œ (ê°œë°œ/ë‚´ë¶€ í…ŒìŠ¤íŠ¸ìš©)"
      )
    end

  desc "Build and distribute to Firebase App Distribution (beta/prod testers)"
  lane :firebase_beta do
    gradle(task: "clean")
    gradle(task: "assembleRelease")

    # 2) debug APK ê²½ë¡œ ë™ì ìœ¼ë¡œ ì°¾ê¸°
    apk_path = lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH]
    UI.user_error!("APK ê²½ë¡œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤") unless apk_path

    UI.message("ì„ íƒ ëœ DEBUG APK ê²½ë¡œ : #{apk_path}")

    UI.message("FIREBASE_APP_ID_ANDROID_DEBUG = #{ENV['FIREBASE_APP_ID_ANDROID_DEBUG']}")
    UI.message("FIREBASE_TESTERS_DEBUG = #{ENV['FIREBASE_TESTERS_DEBUG']}")

    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID_ANDROID"],
      android_artifact_type: "APK",
      android_artifact_path: apk_path,
      service_credentials_file: "fastlane/account-firebase-app-distribution.json",

      testers: ENV["FIREBASE_TESTERS"],
      release_notes: "ìë™ ë°°í¬ í…ŒìŠ¤íŠ¸ ë¹Œë“œì…ë‹ˆë‹¤."
    )
  end

  #####################################
  # ì¶”í›„ ìŠ¤í† ì–´ ë°°í¬ê°€ í•„ìš”í•  ê²½ìš°ì— ì‚¬ìš© ì„¤ì •
  # ëª…ë ¹ì–´ : bundle exec fastlane production
  #####################################
  desc "í”„ë¡œë•ì…˜ íŠ¸ë™(ì‹¤ì œ ì‹¬ì‚¬ìš©)ìœ¼ë¡œ ë°”ë¡œ ì—…ë¡œë“œ"
  lane :production do
    gradle(task: "clean")
    gradle(
        task: "bundle",
        build_type: "Release"
    ) # ./gradlew bundleRelease ì™€ ë™ì¼

    aab_path = Actions.lane_context[SharedValues::GRADLE_AAB_OUTPUT_PATH]
    UI.user_error!("ABB ê²½ë¡œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤") unless aab_path

    UI.message("ì„ íƒ ëœ aab ê²½ë¡œ : #{aab_path}")

    # ì œëª© ì„¤ì •
    version_name = sh("grep versionName app/build.gradle | awk '{print $2}'").strip.gsub('"','')
    version_code = sh("grep versionCode app/build.gradle | awk '{print $2}'").strip
    release_title = "v#{version_name} (#{version_code})"

    # Play Store í”„ë¡œë•íŠ¸ íŠ¸ë™ì— ì—…ë¡œë“œ
    upload_to_play_store(
        track: "production", # ì‹¤ì œ í”„ë¡œë•íŠ¸ íŠ¸ë™
        aab: aab_path,
        skip_upload_images: true, # ì´ë¯¸ì§€/ìŠ¤í¬ë¦°ìƒ·ì€ ì½˜ì†”ì—ì„œ ê´€ë¦¬í•˜ë©´ true
        skip_upload_screenshots: true,
        skip_upload_changelogs: false, # changelog ì˜¬ë¦¬ë©´ true/false ì„ íƒ
        release_title: release_title,
        release_status: "draft" # ì‹¬ì‚¬ ì „/ê²€í† ìš©ì´ë©´ draft, ë°”ë¡œ ë°°í¬ë©´ completed
    )
  end

  #####################################
  # ì¶”í›„ ë‚´ë¶€ í…ŒìŠ¤íŠ¸ í•„ìš”í•  ê²½ìš°ì— ì‚¬ìš© ì„¤ì •(aab)
  # ëª…ë ¹ì–´ : bundle exec fastlane internal_test_aab
  #####################################
  desc "ë‚´ë¶€ í…ŒìŠ¤íŠ¸ íŠ¸ë™ì— ì—…ë¡œë“œ(App Bundle)"
  lane :internal_test_aab do
    gradle(task: "clean")
    gradle(
        task: "bundle",
        build_type: "Release"
    )

    aab_path = Actions.lane_context[SharedValues::GRADLE_AAB_OUTPUT_PATH]
    UI.user_error!("ABB ê²½ë¡œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤") unless aab_path

    UI.message("ì„ íƒ ëœ aab ê²½ë¡œ : #{aab_path}")

    # ì œëª© ì„¤ì •
    version_name = sh("grep versionName app/build.gradle | awk '{print $2}'").strip.gsub('"','')
    version_code = sh("grep versionCode app/build.gradle | awk '{print $2}'").strip
    release_title = "[ë‚´ë¶€ í…ŒìŠ¤íŠ¸] v#{version_name} (#{version_code})"

    # Play Store ë‚´ë¶€ í…ŒìŠ¤íŠ¸ íŠ¸ë™ì— ì—…ë¡œë“œ
    upload_to_play_store(
        track: "internal", # ë‚´ë¶€ í…ŒìŠ¤íŠ¸ íŠ¸ë™
        aab: aab_path,
        skip_upload_images: true, # ì´ë¯¸ì§€/ìŠ¤í¬ë¦°ìƒ·ì€ ì½˜ì†”ì—ì„œ ê´€ë¦¬í•˜ë©´ true
        skip_upload_screenshots: true,
        skip_upload_changelogs: false, # changelog ì˜¬ë¦¬ë©´ true/false ì„ íƒ
        release_title: release_title,
        release_status: "completed" # internalì€ ê·¸ëƒ¥ completedë¡œ ë°”ë¡œ ë°°í¬í•´ë„ ë¨
    )
  end

  #####################################
  # ì¶”í›„ ë‚´ë¶€ í…ŒìŠ¤íŠ¸ í•„ìš”í•  ê²½ìš°ì— ì‚¬ìš© ì„¤ì •(apk)
  # ëª…ë ¹ì–´ : bundle exec fastlane internal_test_apk
  #####################################
  desc "ë‚´ë¶€ í…ŒìŠ¤íŠ¸ íŠ¸ë™ì— ì—…ë¡œë“œ(Apk)"
  lane :internal_test_apk do
      gradle(task: "clean")
      gradle(task: "assembleRelease")

      apk_path = lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH]
      UI.user_error!("APK ê²½ë¡œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤") unless apk_path

      UI.message("ì„ íƒ ëœ DEBUG APK ê²½ë¡œ : #{apk_path}")

      # ì œëª© ì„¤ì •
      version_name = sh("grep versionName app/build.gradle | awk '{print $2}'").strip.gsub('"','')
      version_code = sh("grep versionCode app/build.gradle | awk '{print $2}'").strip
      release_title = "[ë‚´ë¶€ í…ŒìŠ¤íŠ¸] v#{version_name} (#{version_code})"

      # Play Store ë‚´ë¶€ í…ŒìŠ¤íŠ¸ íŠ¸ë™ì— ì—…ë¡œë“œ
      upload_to_play_store(
        track: "internal", # ë‚´ë¶€ í…ŒìŠ¤íŠ¸ íŠ¸ë™
        apk: apk_path,
        skip_upload_images: true, # ì´ë¯¸ì§€/ìŠ¤í¬ë¦°ìƒ·ì€ ì½˜ì†”ì—ì„œ ê´€ë¦¬í•˜ë©´ true
        skip_upload_screenshots: true,
        skip_upload_changelogs: false, # changelog ì˜¬ë¦¬ë©´ true/false ì„ íƒ
        release_title: release_title,
        release_status: "completed" # internalì€ ê·¸ëƒ¥ completedë¡œ ë°”ë¡œ ë°°í¬í•´ë„ ë¨
      )
  end
end
